
<!DOCTYPE html>
<html lang="en">
<head>
    <title>MetaMask Login Demo</title>
    <meta charset="UTF-8">
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>
<meta name="viewport" content="width=device-width, initial-scale=1">

    <!--===============================================================================================-->
    <link rel="icon" type="image/png" href="./images/icons/favicon.ico"/>
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./vendor/bootstrap/css/bootstrap.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./fonts/font-awesome-4.7.0/css/font-awesome.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./vendor/animate/animate.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./vendor/css-hamburgers/hamburgers.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./vendor/select2/select2.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./css/util.css">
    <link rel="stylesheet" type="text/css" href="./css/main.css">
    <!--===============================================================================================-->
    <script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js"></script>
    <script src="./node_modules/web3/dist/web3.min.js"></script>
</head>

<body>
<div class="limiter">
    <div class="container-login100">
        <div class="wrap-login100">

            <div class="login100-pic" data-tilt>
            	<p style="height:100%; vertical-align:middle;">
                <img src="./images/img-04.png" alt="IMG">
              </p>
            </div>

            <form class="login100-form validate-form">
            	  <br/>  <br/>
                <span class="login100-form-title">
                    YoCity 綁定 MetaMask 錢包
                </span>
                <div class="text-center txt2" id="divaddr" style="overflow-wrap: break-word;margin:3px;"></div>

                <div class="text-center txt2" id="qrcode" style="overflow-wrap:break-word; margin:3px;" >
                    <a id="url" style="display: none;"></a>
                    <p id="qr-wrapper" style="display: none;vlign:center;"></p>
                </div>

                <div class="container-login100-form-btn">
                    <button class="login100-form-btn" type="button" onclick="connectMetaMask();" id="btnConnect">
                        連接 Wallet
                    </button>
                    <button class="login100-form-btn" type="button" onclick="login();" id="btnLogin" style="display: none;">
                        已連接，可以操作區塊鏈
                    </button>
                    <button class="login100-form-btn" type="button" onclick="redirectYoCity();" id="btnYoCity" style="display: none;">
                        🎉 轉導 YoCity🎉
                    </button>
                </div>





            </form>

            <div style="display:none">
                <div class="text-center p-t-12">
						<span class="txt1">
							此Demo演示使用 MetaMask 登入，具體教學請參考這裡：
						</span>
                    <a class="txt2" href="https://www.frank.hk/blog/metamask-login/" target="_blank">
                        如何用 metamask 登入。
                    </a>
                </div>
                <div class="text-center p-t-136">
                    <a class="txt2" href="https://www.frank.hk/blog">
                        查看更多網誌內容
                        <i class="fa fa-long-arrow-right m-l-5" aria-hidden="true"></i>
                    </a>
                </div>
                <div style="font-size: 80%; margin-top: 30px;display: block;">其它 demo：<br/>
                    <a style="" href="https://demo.frank.hk/demo/nft" target="_blank">NFT Gallery</a>
                    <a style="margin-left: 15px;" href="https://demo.frank.hk/demo/metamasklogin" target="_blank">MetaMask 登入</a>
                    <a style="margin-left: 15px;" href="https://demo.frank.hk/demo/nft-erc1155" target="_blank">ERC1155 NFT</a>
                    <a style="margin-left: 15px;" href="https://demo.frank.hk/demo/nft-royalty" target="_blank">NFT 版稅</a>
                    <a style="margin-left: 15px;" href="https://demo.frank.hk/demo/nft-usdt" target="_blank">ERC20代幣買NFT</a>
                    <a style="margin-left: 15px;" href="https://demo.frank.hk/demo/nft-mystery-box" target="_blank">盲盒 NFT</a><br/>
                    <a style="" href="https://demo.frank.hk/demo/nft-list" target="_blank">讀取指定地址所有 NFT</a>
                    <a style="margin-left: 15px;" href="https://demo.frank.hk/demo/nft-lottery" target="_blank">Smart Contract 大抽獎</a>
                    <a style="margin-left: 15px;" href="https://demo.frank.hk/demo/nft-signature" target="_blank">智能合約簽名驗證</a>
                    <a style="margin-left: 8px;" href="https://demo.frank.hk/demo/crossmint" target="_blank">信用卡買NFT</a>

                </div>
            </div>

        </div>

    </div>
</div>

<!--===============================================================================================-->
<script src="./vendor/jquery/jquery-3.2.1.min.js"></script>
<!--===============================================================================================-->
<script src="./vendor/bootstrap/js/popper.js"></script>
<script src="./vendor/bootstrap/js/bootstrap.min.js"></script>
<!--===============================================================================================-->
<script src="./vendor/select2/select2.min.js"></script>
<!--===============================================================================================-->
<script src="./vendor/tilt/tilt.jquery.min.js"></script>
<script >
    var address;
    var signatureMetamask;
    var idMember = 'b1fef736-af64-44dc-b5c7-d5ace8dd7a01-' + (new Date()).getTime();
   // alert(idMember);


    $('.js-tilt').tilt({
        scale: 1.1
    })

    function redirectYoCity() {
    	var urlTarget = 'https://cht.yocity.com.tw/goscene.html?subjectid=16&idMember=' + idMember + '&address=' + address + '&signature=' + signatureMetamask;
        alert(urlTarget);
        if ((navigator.userAgent.indexOf("Android") >= 0) && !(navigator.userAgent.indexOf("MetaMaskMobile") >=0 )) {
            //alert('Android general; launch metamask-->');
            window.location.href = 'chrome://' + urlTarget;
        } else if ((navigator.userAgent.indexOf("iPhone") >= 0) && !(navigator.userAgent.indexOf("MetaMaskMobile") >=0 )) {
            //alert('iPhone general; launch metamask-->');
            window.location.href = 'chrome://' + urlTarget;
        } else {
            window.location.href = urlTarget;
        }


	}


    function login() {
        $("#btnLogin").attr("disabled", true);
        $.ajax({
            type: "GET",
            //url: "./getNonce.jsp?address="+address,
            url: "https://demo.frank.hk/api/metamask/nonce/" + address,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function(data){
                data.payload = data.payload.replace("frank.hk", "YoCity");

                $("#divaddr").append("<div class=\"alert alert-secondary\" style=\"color:#464a4e;background-color:#e7e8ea;border-color:#dddfe2;\" role=\"alert\">第二步: Backend 取得 Nonce成功： <small>"+data.payload+"</small></div>");
                //$("#divaddr").append("<div class=\"alert alert-secondary\" role=\"alert\">Hex Nonce (應該同 MetaMask 顯示一致)： <small>"+window.web3.utils.utf8ToHex(data.payload)+"</small></div>");

                //var hexData = window.web3.utils.utf8ToHex(data.payload);
                var hexData = data.payload;
                //var hexData = "Hello welcome to YoCity";
                console.log("payload", data.payload);
                $("#btnLogin").html("等待 MetaMask 授權 ");
                window.web3.eth.personal.sign(hexData, address, function(result, signature){
                    console.log(result);
                    console.log(signature);
 
                    signatureMetamask = signature;
                    $("#divaddr").append("<div class=\"alert alert-warning\" style=\"color:#856404;background-color:#fff3cd;border-color:#ffeeba;\" role=\"alert\">第三步: 取得 MetaMask 簽名： <small>"+signature+"</small></div>");

 					var dataBinding = JSON.stringify({ socialLoginSeq: 1, socialLoginUserId:idMember, walletSeq:1, walletAddress:address });

					//alert(dataBinding);

                    if (!result) {
                        $.ajax({
                            type: "POST",
                            url: "https://10.144.91.143:8087/meta/api/binding-wallet",
                            data: dataBinding,
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            success: function(loginResult){
                            //alert(JSON.stringify(loginResult));
                            //////////////////////////////{  "returnCode": "0000",   "returnMessage": "成功" }
                                if (loginResult.returnCode == '0000') {
                                    // login success
                                    $("#divaddr").append("<div class=\"alert alert-info\" style=\"color:#0c5460;background-color:#d1ecf1;border-color:#bee5eb;\" role=\"alert\">第四步: Backend 收到簽章(待通知SSO/OAuth)</div>");
                                    $("#divaddr").append("<div class=\"alert alert-success\" style=\"color:#155724;background-color:#d4edda;border-color:#c3e6cb;\" role=\"alert\">🎉 登入成功,可以轉導至YoCity 🎉</div>");
                                    //style="display: none;"
                                    //alert(JSON.stringify(loginResult));
                                    //$("#btnYoCity").html('🎉 轉導 YoCity 🎉');
                                    $("#btnLogin").hide();
                                    $("#btnYoCity").show();
                                } else if (loginResult.returnCode == '1003') {
                                    $("#divaddr").append("<div class=\"alert alert-danger\" style=\"color:#cc5733;background-color:#33edcc;border-color:#c3e6cb;\" role=\"alert\">第四步: 重覆綁定</div>");
                                    $("#btnLogin").hide();
                                    $("#btnYoCity").show();
                                } else {
                                    $("#divaddr").append("<div class=\"alert alert-danger\" style=\"color:#cc5733;background-color:#33edcc;border-color:#c3e6cb;\" role=\"alert\">第四步: Backend 驗證簽名失敗</div>");
                                    $("#btnLogin").hide();
                                }

                            },
                            failure: function(errMsg) {
                                alert(errMsg);
                            }
                        });

                    }
                });
            },
            failure: function(errMsg) {
                alert(errMsg);
            }
        });
    }

    function connectMetaMask(){
        window.web3 = new Web3(window.web3.currentProvider);
        ethereum.request({ method: 'eth_requestAccounts' }).then((result) => {
            address = result[0];
            $("#divaddr").append("<div class=\"alert alert-primary\" style=\"color:#004085;background-color:#cce5ff;border-color:#b8daff;\" role=\"alert\">第一步: 錢包連接成功： "+result[0]+"<br/>請繼續</div>");
            $("#btnConnect").hide();
            $("#btnLogin").show();
        }).catch((error) => {
            console.log("error",error);
        });
    }


    $(function(){
        if (window.web3) {
        } else if ((navigator.userAgent.indexOf("X11; Linux") >= 0) && (navigator.userAgent.indexOf("KHTML, like Gecko") >=0 )) {
						// in Unity
            $("#divaddr").append("<div class=\"alert alert-danger\" role=\"alert\">請選 [Binding Metamask] YoCity將引導您轉導到Metamask App錢包進行綁定。</div>");
            $("#url").hide();
            $("#qr-wrapper").show();
            $("#btnConnect").hide();
            $("#btnLogin").hide(); 
				} else {
						// in Browser not Extension
            $("#divaddr").append("<div class=\"alert alert-danger\" role=\"alert\">你的瀏覽器似乎沒有安裝 MetaMask 插件，可以先安裝再試，或由Metamask App進行綁定。</div>");
            $("#url").show();
            $("#qr-wrapper").show();
            $("#btnConnect").hide();
            $("#btnLogin").hide();
        }
        
       // $("#qr-wrapper").show();
    });


</script>
<!--===============================================================================================-->
<script src="./js/main.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-25129655-2"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-25129655-2');
</script>
<script>



function renderUrl(url){
	document.getElementById("url").href = url;
	document.getElementById("url").innerText = '透過 Metamask App 綁定 YoCity';

	const baseImgUrl = "http://api.qrserver.com/v1/create-qr-code/?color=000000&bgcolor=FFFFFF&data=${DATA}&qzone=1&margin=0&size=250x250&ecc=L";
	const qrCodeUrl = baseImgUrl.replace('${DATA}', escape(url));

	if(document.getElementById("qr-wrapper").firstElementChild){
		const img = document.getElementById("qr-wrapper").firstElementChild;
		img.src = qrCodeUrl;
	}else{
		const img = document.createElement("img");
		img.style.width = "125px"; 
		img.style.height = "125px";
		img.src = qrCodeUrl
		document.getElementById("qr-wrapper").appendChild(img);
	}
}

    var dapp_url = "https://metamask.app.link/dapp/ephemeral-cascaron-b1d97f.netlify.app/login/index.html";
    //var dapp_url = "https://metamask.app.link/dapp/http://10.144.132.65:8082/login/index.html";
    var BASE_URL = 'https://metamask.app.link';
	if (dapp_url.search("https://") !== -1){
		var url = BASE_URL + '/dapp/' + dapp_url.replace('https://', '');
		renderUrl(url);
	} else {
		alert('The url needs to start with https://');
	}
	
 
    if ((navigator.userAgent.indexOf("Android") >= 0) && !(navigator.userAgent.indexOf("MetaMaskMobile") >=0 )) {
        // alert('Android general; launch metamask-->' + deeplink);
        //window.location.href = deeplink; 
    } else if ((navigator.userAgent.indexOf("iPhone") >= 0) && !(navigator.userAgent.indexOf("MetaMaskMobile") >=0 )) {
        // alert('iPhone general; launch metamask-->');
        //window.location.href = deeplink; 
    }
 





</script>



</body>
</html>