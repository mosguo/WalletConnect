<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>metamask test</title>
    <!--//https://cdnjs.cloudflare.com/ajax/libs/web3/4.2.2/-->
    <script src="web3.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    
    <script src="https://apis.google.com/js/platform.js?onload=init" async defer></script>
<script>
function updateHtmlContent() 
{
	var addressElement = document.getElementById("address");
  addressElement.textContent = 'mskuoAfter';	
}

function prototype_deletctUserAgent(){
		// Opera 8.0+
		var isOpera = (!!window.opr && !!opr.addons) || !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;
		
		// Firefox 1.0+
		var isFirefox = typeof InstallTrigger !== 'undefined';
		
		// Safari 3.0+ "[object HTMLElementConstructor]" 
		var isSafari = /constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === "[object SafariRemoteNotification]"; })(!window['safari'] || (typeof safari !== 'undefined' && window['safari'].pushNotification));
		
		// Internet Explorer 6-11
		var isIE = /*@cc_on!@*/false || !!document.documentMode;
		
		// Edge 20+
		var isEdge = !isIE && !!window.StyleMedia;
		
		// Chrome 1 - 79
		console.log('window.chrome(value):', !!window.chrome);   
		console.log('window.chrome.webstore(value):', !!window.chrome.webstore);   
		console.log('window.chrome.runtime(value):', !!window.chrome.runtime);   
		console.log('navigator.userAgent.indexOf Chrome/ (else):', (navigator.userAgent.indexOf(' Chrome/') >= 0));   
		
		var isChrome = (!!window.chrome && (!!window.chrome.webstore || !!window.chrome.runtime)) || (navigator.userAgent.indexOf(' Chrome/') >= 0);
		
		// Edge (based on chromium) detection
		var isEdgeChromium = isChrome && (navigator.userAgent.indexOf("Edg") != -1);
		
		// Blink engine detection
		var isBlink = (isChrome || isOpera) && !!window.CSS;
		
		var output = 'Detecting browsers by ducktyping:\n';
		output += 'isFirefox: ' + isFirefox + '\n<br>';
		output += 'isChrome: ' + isChrome + '\n<br>';
		output += 'isSafari: ' + isSafari + '\n<br>';
		output += 'isOpera: ' + isOpera + '\n<br>';
		output += 'isIE: ' + isIE + '\n<br>';
		output += 'isEdge: ' + isEdge + '\n<br>';
		output += 'isEdgeChromium: ' + isEdgeChromium + '\n<br>';
		output += 'isBlink: ' + isBlink + '\n<br>'; 																				


var elementBrowser = document.getElementById("browser");
elementBrowser.textContent = output;	


}

function getBrowserVersion() {

		// This code snippet splits a string in a special notation
		var splitUpString;
		console.log('userAgent:', navigator.userAgent);
		
		if (navigator.userAgent.includes("Chrome")) {
		  // YES! The user is suspected to support look-behind regexps
		  // DO NOT USE /(?<=[A-Z])/. It will cause a syntax error in
		  // browsers that do not support look-behind expressions
		  // because all browsers parse the entire script, including
		  // sections of the code that are never executed.
		  const camelCaseExpression = new RegExp("(?<=[A-Z])");
		  splitUpString = (str) => String(str).split(camelCaseExpression);
		  console.log('getBrowserVersion(if):', splitUpString);   
		  return splitUpString;
	  
		} else {
		  // This fallback code is much less performant, but works
		  splitUpString = (str) =>
		    String(str)
		      .split(/(.*?[A-Z])/)
		      .filter(Boolean);
		    console.log('getBrowserVersion(else):', splitUpString);   
			return splitUpString;
		}
}

function updateConsole(dat) 
{
	var elemConsole = document.getElementById("console");
  elemConsole.textContent += dat;	
}

</script>
    
</head>
<body>
ChtLand WalletConnect V0.20.0946	
	
    <h1>終端用戶:</h1>

	  <b>Browser:</b><div id="browser"></div><br/>
    <b>User-Agent:</b><div id="agent"></div><br/>
    <b>idMember:</b><div id="idMember"></div><br/>
	
    <h1>錢包Address:</h1>
    <div id="address"></div>
    <h1>錢包餘額:</h1>
    <div id="balance"></div>
 <hr/>
    <b>console:</b><div id="console"></div><br/>

<!-- Code injected by live-server -->
<script>
	var addressElement = document.getElementById("address");
	addressElement.textContent = '未連結錢包';	
	
	//navigator.userAgent
	console.log('Browser:', navigator.userAgent);
	var elemAgent = document.getElementById("agent");
	elemAgent.textContent = navigator.userAgent;	 
	
updateConsole('initial');	
 
function isChrome() {
	return (!!window.chrome && (!!window.chrome.webstore || !!window.chrome.runtime)) || (navigator.userAgent.indexOf(' Chrome/') >= 0 && navigator.userAgent.indexOf(' Edg/') < 0);
}
function isEdge() {
	return (!!window.chrome && (!!window.chrome.webstore || !!window.chrome.runtime)) || (navigator.userAgent.indexOf(' Chrome/') >= 0 && navigator.userAgent.indexOf(' Edg/') >= 0);
}
function isMetamaskWebView() {
	return ((navigator.userAgent.indexOf('WebView MetaMaskMobile/') >= 0);
} 
 
updateConsole('meta.js start');	
 
	  // 檢查是否存在 MetaMask
updateConsole('檢查是否存在 MetaMask');	
	  if (typeof window.ethereum !== 'undefined') {
			var idMember = 'fromIndex';  
			var browser = ''; 
	    // 初始化 Web3.js
	    const web3 = new Web3(window.ethereum);
			var userAddress = '';
			var balance = ''; 
			
	    // 請求用戶授權
	    try {
	      // 使用 ethereum.request 方法發送請求
	      const accounts = await window.ethereum.request({
	        method: 'eth_requestAccounts',
	      });
	      console.log('MetaMask is connected.');
	      console.log('Accounts:', accounts);
	      console.log('privateKey:', accounts.privateKey);
	
	      // 獲取用戶地址
	      userAddress = accounts[0];
	      //window.ethereum.selectedAddress ;////const userAddress = window.ethereum.request({method: 'eth_accounts'})
	      
	      
	      console.log('User Address:', userAddress);
	      var addressElement = document.getElementById("address");
	      addressElement.textContent = userAddress;
	
	      // 獲取 MetaMask 餘額
	      balance = await web3.eth.getBalance(userAddress);
	      console.log('Balance:', web3.utils.fromWei(balance, 'ether'), 'ETH');
	      var balanceElement = document.getElementById("balance");
	      balanceElement.textContent = web3.utils.fromWei(balance, 'ether');
	    //window.location.href = 'http://10.144.132.65:8080/metamask/board.html?address=' + userAddress + '&balance=' + balance;
updateConsole('獲取 MetaMask 餘額:'+balance);
	     
	    } catch (err) {
	      console.error('Error connecting to MetaMask:', err.message); 
	    }
	  } else {
	  	const userAddress = '';
	  	const balance = '';
	    console.log('MetaMask extension/Pplugin not detected.');
updateConsole('MetaMask extension/Pplugin not detected.');
	    //window.location.href = 'https://metamask.app.link/dapp/10.144.132.65:8080/metamask/board.html?address=' + userAddress + '&balance=' + balance;
	  }

		//判斷進行不userAgent同方式的導向
		console.log('userAgent:', navigator.userAgent);
		var protocolServer = 'https://';
		var hostServer = 'ephemeral-cascaron-b1d97f.netlify.app';
		//hostServer = 'http://10.144.132.65:8080';
		
		//Chrome
		//Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36
		
 		if (isChrome()) {
			browser = 'Chrome'; 
 			console.log('The Browser is Chrome.');
updateConsole('The Browser is Chrome.');
			window.location.href = protocolServer + hostServer + '/metamask/board.html?browser=' + browser + '&idMember=' + idMember + '&address=' + userAddress + '&balance=' + balance;
 		} else if (isEdge()){
			browser = 'Edge'; 
 			console.log('The Browser is Edge.');
updateConsole('The Browser is Edge.');
			window.location.href =  protocolServer + hostServer + '/metamask/board.html?browser=' + browser + '&idMember=' + idMember + '&address=' + userAddress + '&balance=' + balance;
 		} else if (isMetamaskWebView()){
			browser = 'MetamaskWebView'; 
 			console.log('The Browser is MetamaskWebView.');
updateConsole('The Browser is MetamaskWebView.');
			//window.location.href = 'https://metamask.app.link/dapp/' + hostServer + '/metamask/board.html?browser=' + browser + '&idMember=' + idMember + '&address=' + userAddress + '&balance=' + balance;
			window.location.href = protocolServer' + hostServer + '/metamask/board.html?browser=' + browser + '&idMember=' + idMember + '&address=' + userAddress + '&balance=' + balance;


 		} else {
			browser = 'Others'; 
 			console.log('The Browser is Others.');
updateConsole('The Browser is Others.');
			window.location.href = 'https://metamask.app.link/dapp/' + hostServer + '/metamask/board.html?browser=' + browser + '&idMember=' + idMember + '&address=' + userAddress + '&balance=' + balance;
 		}
			
 




updateConsole('finished');	

























</script> 
</body>
</html>